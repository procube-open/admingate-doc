---
sidebar_position: 10
---
# データベース
ファイルサーバのデータベースとして、MongoDBのGridFSを採用しており、接続にはMongooseを使う。
データベース名は`files_db`として、以下のコレクションが存在する。

| コレクション名 | 説明                     |
|----------------|--------------------------|
| `fs.files`     | ファイルのメタデータ     |
| `fs.chunks`    | ファイルの内部データ     |
| `fs.dirs`      | ディレクトリのメタデータ |
| `fs.works`     | 作業のメタデータ         |

## fs.files
ファイルのメタデータを保持するコレクション。GridFS標準の実装に従う。
保持するパラメータは以下の表の通り

| パラメータ               | 説明                                                                                                                        | フォーマット       |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------|--------------------|
| `_id`                    | MongoDB上のオブジェクトID                                                                                                   | `ObjectId`         |
| `filename`               | ファイル名を表す文字列                                                                                                      | `string`           |
| `length`                 | ファイルサイズ                                                                                                              | `number`           |
| `chunkSize`              | fs.chunksにおける1チャンクのサイズ                                                                                          | `number`           |
| `uploadDate`             | 最終更新日時                                                                                                                | `Date`             |
| `metadata.accessHistory` | 更新履歴                                                                                                                    | `Array<acHistory>` |
| `metadata.status`        | ウイルススキャン状況。詳細については[ウイルススキャンページ](/docs/forDev/fileserver/avscan)を参照。                        | `string`           |
| `metadata.parent_id`     | 親に対応するディレクトリの`fs.dirs`の`_id`を文字列化したもの                                                                | `string`           |
| `metadata.fullpath`      | `"root"`から始まり、ファイルに到達するまでのパスの順にディレクトリの`dirname`を配列でつなげて最後に`filename`を入れたもの。 | `Array<string>`    |
| `metadata.unique`        | 最初の文字を`"/"`として、その後に`metadata.fullpath`を`"/"`でつなげたもの。uniqueな値をとる。                               | `string`           |

また`metadata.accessHistory`で配列として格納される`acHistory`フォーマットは以下のパラメータを持つ

| パラメータ | 説明                                                                                             | フォーマット |
|------------|--------------------------------------------------------------------------------------------------|--------------|
| `Type`     | アクセスの種別。`"upload"`,`"update"`,`"download"`,`"rename"`,`"scan"`のいずれかの文字列が入る。 | `string`     |
| `Date`     | アクセス日時                                                                                     | `Date`       |
| `Protocol` | プロトコル。詳細は各プロトコルページを参照。                                                     | `string`     |
| `SourceIP` | 送信元IP                                                                                         | `string`     |
| `Info`     | 詳細・補足情報                                                                                   | `string`     |

## fs.chunks
ファイルの内部データを保持するコレクション。GridFS標準の実装に従う。
保持するパラメータは以下の表の通り。

| パラメータ | 説明                                      | フォーマット              |
|------------|-------------------------------------------|---------------------------|
| `_id`      | MongoDB上のオブジェクトID                 | `ObjectId`                |
| `files_id` | 対応するファイルの`fs.files`における`_id` | `ObjectId`                |
| `n`        | 読み込む順序を表す数字。0から始まる。     | `number`                  |
| `data`     | チャンク分けされたデータ                  | `Binary.createFromBase64` |

## fs.dirs
ディレクトリのメタデータを保持するコレクション。
保持するパラメータは以下の通り。

| パラメータ   | 説明                                                                                                | フォーマット    |
|--------------|-----------------------------------------------------------------------------------------------------|-----------------|
| `_id`        | MongoDB上のオブジェクトID                                                                           | `ObjectId`      |
| `dirname`    | ディレクトリ名を表す文字列                                                                          | `string`        |
| `uploadDate` | 作成日時                                                                                            | `Date`          |
| `fullpath`   | `"root"`から始まり、ファイルに到達するまでのパスの順にディレクトリの`dirname`を配列でつなげたもの。 | `Array<string>` |
| `unique`     | 最初の文字を`"/"`として、その後に`fullpath`を`"/"`でつなげたもの。uniqueな値をとる。                | `string`        |

## fs.works
作業のメタデータを保持するコレクション。
保持するパラメータは以下の通り。

| パラメータ      | 説明                      | フォーマット    |
|-----------------|---------------------------|-----------------|
| `_id`           | MongoDB上のオブジェクトID | `ObjectId`      |
| `idmIdentifier` | 作業ID                    | `string`        |
| `password`      | ログインパスワード        | `string`        |
| `name`          | 作業名                    | `string`        |
| `whitelist`     | ログイン可能IP一覧        | `Array<string>` |