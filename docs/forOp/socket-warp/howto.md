---
sidebar_position: 20
---

# 利用方法

socket-warp 機能を利用する場合、接続する環境に socket-warp-connector(以下 SWC)を配置し、socket-warp-listener(以下 SWL)に接続する必要があります。
大まかに以下の手順に従って接続します。

- SCEP クライアントの作成
- シークレットの作成
- クライアント証明書の発行
- SWC の配置と設定
- SWC を SWL に接続

順を追って説明します。

## SCEP クライアントの作成

まず、SWL が SWC の認証に用いる SCEP クライアントを作成します。
SCEP サーバの WebUI に管理モードでアクセスし、クライアントを作成して下さい。
クライアント ID は一意で識別可能なものとして、属性は特に設定する必要はありませんが、JSON 読み取り可能な形にして下さい。
:::note
後述の接続先登録で複数の SWC を登録する場合、区切り文字として`,`を利用します。**クライアント ID に`,`は使用しないでください。**
:::

## シークレットの作成

クライアント証明書の発行では、一度のみ利用可能な**シークレット**というパスワードを利用します。
作成したクライアントをクリックし、詳細ページに移動すると「シークレットを作成」というブロックがあります。
ここで、シークレットと有効期限を設定し、作成ボタンを押すことでシークレットが作成できます。

## クライアント証明書の発行

クライアント証明書の発行では、以下の二種類の方法があります。

- PKCS12 形式でダウンロードし、openssl を用いて証明書ファイル群を PEM に書き出す
- SCEP クライアントバイナリファイルをダウンロードし、証明書ファイル群を生成する

それぞれ解説します。

### PKCS12 形式証明書を分解する

作成したシークレットを用いてブラウザ上で証明書を発行することができます。発行するには、「証明書を #PKCS12 形式で発行」というブロックでシークレットとファイルパスワードを入力し、「証明書発行」ボタンを押して下さい。
p12 ファイルのダウンロードが完了したら、以下の openssl コマンドで証明書を分解します。

```
openssl pkcs12 -out cacert.pem -cacerts -nokeys -in {証明書ファイル}.p12
openssl pkcs12 -out cert.pem -clcerts -nokeys -in {証明書ファイル}.p12
openssl pkcs12 -out key.pem -nocerts -nodes -in {証明書ファイル}.p12
```

各コマンド実行時に設定したファイルパスワードを入力する必要があります。また、出力されたファイルには`subject`や`issuer`などの情報を記載したヘッダが表示されているのでこれを削除して下さい。

### SCEP で生成する

SCEP クライアントバイナリファイルを実行することで証明書ファイル群が生成されます。バイナリファイルは WebUI のファイル一覧で配布されているものを使って下さい。
例えば`scepclient-linux-amd64`を使う場合、

```
./scepclient-linux-amd64 -uid {クライアント名} -secret {シークレット}
```

を実行することで`cert.pem`と`key.pem`が生成できます。
CA 証明書はバイナリファイルと同様に WebUI でダウンロードして下さい。

## SWC の配置と設定

SCEP の WebUI から**sw_connect_linux**をダウンロードして同階層に**settings.json**というファイルを作成して下さい。
また、settings.json には以下のパラメータを設定して下さい。

```
{
  "client_cert_path": "{クライアント証明書のパス}",
  "client_key_path": "{秘密鍵のパス}",
  "ca_cert_path": "{CA証明書のパス}",
  "server_name": "sw-listener.nsag-dev.procube-demo.jp",
  "service_port": 11443
}
```

## SWC を SWL に接続

以下を実行して SWC ファイルを起動して SWL に接続して下さい。

```
./sw_connector
```

実行ログで`QUIC connected`と表示されれば接続成功です。

